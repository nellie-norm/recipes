<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>what are you cooking up?</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cardo:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        html {
            -webkit-font-smoothing: antialiased;
            text-rendering: optimizeLegibility;
        }
        
        body {
            font-family: 'Cardo', Georgia, serif;
            background: #F9F6EE;
            color: #4B3621;
            min-height: 100vh;
            padding: 40px 20px;
            font-kerning: normal;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        h1 {
            font-size: 34px;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.2px;
            line-height: 1.2;
            color: #4B3621;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 32px;
            font-size: 17px;
        }
        
        .input-section {
            display: flex;
            gap: 12px;
            margin-bottom: 32px;
        }
        
        input[type="text"] {
            flex: 1;
            padding: 14px 16px;
            border: 1px solid #d4c9b8;
            border-radius: 4px;
            background: #fff;
            color: #4B3621;
            font-family: 'Cardo', Georgia, serif;
            font-size: 16px;
            transition: border-color 0.2s;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: #CC5500;
        }
        
        input[type="text"]::placeholder {
            color: #999;
        }
        
        button {
            padding: 14px 24px;
            border: none;
            border-radius: 4px;
            font-family: 'Cardo', Georgia, serif;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        
        .btn-primary {
            background: #CC5500;
            color: white;
        }
        
        .btn-primary:hover {
            opacity: 0.8;
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 24px;
        }
        
        .btn-secondary {
            background: #fff;
            border: 1px solid #d4c9b8;
            color: #4B3621;
            padding: 10px 16px;
            font-size: 15px;
        }
        
        .btn-secondary:hover {
            background: #f5f0e6;
        }
        
        .btn-secondary.active {
            background: #CC5500;
            color: white;
            border-color: #CC5500;
        }
        
        .recipe-card {
            background: #fff;
            border-radius: 6px;
            padding: 32px;
            border: 1px solid #d4c9b8;
        }
        
        .recipe-header {
            margin-bottom: 28px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .recipe-title {
            font-size: 26px;
            font-weight: 700;
            margin-bottom: 12px;
            color: #4B3621;
        }
        
        .recipe-meta {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            color: #666;
            font-size: 15px;
        }
        
        .recipe-meta span {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .section-title {
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #CC5500;
            margin-bottom: 16px;
        }
        
        .ingredients {
            margin-bottom: 32px;
        }
        
        .ingredient {
            padding: 10px 0;
            border-bottom: 1px solid #f0ebe0;
            display: flex;
            font-size: 17px;
            line-height: 1.6;
        }
        
        .ingredient:last-child {
            border-bottom: none;
        }
        
        .ingredient-qty {
            min-width: 110px;
            color: #CC5500;
            font-weight: 700;
        }
        
        .ingredient-item {
            color: #333;
        }
        
        .instructions ol {
            padding-left: 24px;
        }
        
        .instructions li {
            padding: 12px 0;
            padding-left: 8px;
            line-height: 1.8;
            color: #333;
            font-size: 17px;
        }
        
        .instructions li::marker {
            color: #CC5500;
            font-weight: 700;
        }
        
        .error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #b91c1c;
            padding: 16px;
            border-radius: 4px;
            margin-bottom: 16px;
            font-size: 16px;
        }
        
        .loading {
            text-align: center;
            padding: 48px;
            color: #666;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid #d4c9b8;
            border-top-color: #CC5500;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .source-link {
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid #eee;
        }
        
        .source-link a {
            color: #666;
            font-size: 15px;
            text-decoration: none;
            transition: opacity 0.2s;
        }
        
        .source-link a:hover {
            color: #CC5500;
        }
        
        .custom-scale {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #fff;
            padding: 6px 12px;
            border-radius: 4px;
            border: 1px solid #d4c9b8;
        }
        
        .custom-scale input {
            width: 50px;
            padding: 6px;
            border: 1px solid #d4c9b8;
            border-radius: 4px;
            background: #F9F6EE;
            color: #4B3621;
            font-family: 'Cardo', Georgia, serif;
            font-size: 15px;
            text-align: center;
        }
        
        .custom-scale input:focus {
            outline: none;
            border-color: #CC5500;
        }
        
        .custom-scale span {
            color: #666;
            font-size: 15px;
        }
        
        @media (max-width: 600px) {
            body { padding: 24px 16px; }
            h1 { font-size: 28px; }
            .input-section { flex-direction: column; }
            .recipe-card { padding: 24px 20px; }
            .recipe-title { font-size: 22px; }
            .ingredient-qty { min-width: 90px; }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const API_URL = '/api';
        
        function formatQuantity(qty) {
            if (qty === null || qty === undefined) return '';
            
            // Common fractions
            const fractions = {
                0.125: '‚Öõ', 0.25: '¬º', 0.333: '‚Öì', 0.375: '‚Öú',
                0.5: '¬Ω', 0.625: '‚Öù', 0.666: '‚Öî', 0.75: '¬æ', 0.875: '‚Öû'
            };
            
            const whole = Math.floor(qty);
            const decimal = qty - whole;
            
            // Check for close fraction match
            for (const [val, symbol] of Object.entries(fractions)) {
                if (Math.abs(decimal - parseFloat(val)) < 0.02) {
                    return whole > 0 ? `${whole} ${symbol}` : symbol;
                }
            }
            
            // Otherwise show decimal
            if (qty === Math.floor(qty)) return qty.toString();
            return qty.toFixed(2).replace(/\.?0+$/, '');
        }
        
        // Temperature conversion functions
        function celsiusToFahrenheit(c) { return Math.round((c * 9/5) + 32); }
        function fahrenheitToCelsius(f) { return Math.round((f - 32) * 5/9); }
        
        function convertTemperatureInText(text, toUnit) {
            if (!text || toUnit === 'original') return text;
            
            // Match temperatures like "180¬∞C", "350¬∞F", "180C", "350F", "180 ¬∞C", "180 degrees C"
            const celsiusPattern = /(\d+)\s*¬∞?\s*(?:degrees?\s*)?[Cc](?:elsius)?(?!\w)/g;
            const fahrenheitPattern = /(\d+)\s*¬∞?\s*(?:degrees?\s*)?[Ff](?:ahrenheit)?(?!\w)/g;
            
            if (toUnit === 'fahrenheit') {
                // Convert C to F
                text = text.replace(celsiusPattern, (match, temp) => {
                    const f = celsiusToFahrenheit(parseInt(temp));
                    return `${f}¬∞F`;
                });
            } else if (toUnit === 'celsius') {
                // Convert F to C
                text = text.replace(fahrenheitPattern, (match, temp) => {
                    const c = fahrenheitToCelsius(parseInt(temp));
                    return `${c}¬∞C`;
                });
            }
            
            return text;
        }
        
        // Extract time from instruction text
        function extractTime(text) {
            const patterns = [
                /(\d+)\s*-\s*(\d+)\s*(?:minutes?|mins?)/i,  // "5-7 minutes"
                /(\d+)\s*(?:minutes?|mins?)/i,              // "30 minutes"
                /(\d+)\s*-\s*(\d+)\s*(?:hours?|hrs?)/i,     // "1-2 hours"
                /(\d+)\s*(?:hours?|hrs?)/i,                 // "1 hour"
                /(\d+)\s*-\s*(\d+)\s*(?:seconds?|secs?)/i,  // "30-45 seconds"
                /(\d+)\s*(?:seconds?|secs?)/i,              // "30 seconds"
            ];
            
            for (const pattern of patterns) {
                const match = text.match(pattern);
                if (match) {
                    const isHours = /hours?|hrs?/i.test(match[0]);
                    const isSeconds = /seconds?|secs?/i.test(match[0]);
                    
                    let value;
                    if (match[2]) {
                        value = (parseInt(match[1]) + parseInt(match[2])) / 2;
                    } else {
                        value = parseInt(match[1]);
                    }
                    
                    if (isHours) return { seconds: value * 3600, label: match[0] };
                    if (isSeconds) return { seconds: value, label: match[0] };
                    return { seconds: value * 60, label: match[0] };
                }
            }
            return null;
        }
        
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            if (mins >= 60) {
                const hrs = Math.floor(mins / 60);
                const remainMins = mins % 60;
                return `${hrs}:${remainMins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        // Estimate total recipe time from instructions
        function estimateRecipeTime(instructions) {
            if (!instructions || !instructions.length) return null;
            
            let totalSeconds = 0;
            const patterns = [
                { regex: /(\d+)\s*-\s*(\d+)\s*(?:hours?|hrs?)/gi, unit: 3600, range: true },
                { regex: /(\d+)\s*(?:hours?|hrs?)/gi, unit: 3600, range: false },
                { regex: /(\d+)\s*-\s*(\d+)\s*(?:minutes?|mins?)/gi, unit: 60, range: true },
                { regex: /(\d+)\s*(?:minutes?|mins?)/gi, unit: 60, range: false },
                { regex: /(\d+)\s*-\s*(\d+)\s*(?:seconds?|secs?)/gi, unit: 1, range: true },
                { regex: /(\d+)\s*(?:seconds?|secs?)/gi, unit: 1, range: false },
            ];
            
            const allText = instructions.join(' ');
            
            // Track what we've already matched to avoid double counting
            let matched = new Set();
            
            for (const { regex, unit, range } of patterns) {
                let match;
                while ((match = regex.exec(allText)) !== null) {
                    const matchStr = match[0];
                    if (matched.has(match.index)) continue;
                    matched.add(match.index);
                    
                    let value;
                    if (range && match[2]) {
                        // Take average of range
                        value = (parseInt(match[1]) + parseInt(match[2])) / 2;
                    } else {
                        value = parseInt(match[1]);
                    }
                    totalSeconds += value * unit;
                }
            }
            
            if (totalSeconds === 0) return null;
            
            // Format as human readable
            const hours = Math.floor(totalSeconds / 3600);
            const mins = Math.floor((totalSeconds % 3600) / 60);
            
            if (hours > 0 && mins > 0) {
                return `~${hours}h ${mins}m`;
            } else if (hours > 0) {
                return `~${hours}h`;
            } else {
                return `~${mins}m`;
            }
        }
        
        function App() {
            const [url, setUrl] = React.useState('');
            const [originalRecipe, setOriginalRecipe] = React.useState(null);
            const [recipe, setRecipe] = React.useState(null);
            const [loading, setLoading] = React.useState(false);
            const [error, setError] = React.useState(null);
            const [customScale, setCustomScale] = React.useState('1');
            const [currentScale, setCurrentScale] = React.useState(1);
            
            const fileInputRef = React.useRef(null);
            
            const scrapeRecipe = async () => {
                if (!url.trim()) return;
                
                setLoading(true);
                setError(null);
                setShowShoppingList(false);
                setShoppingList(null);
                
                try {
                    const res = await fetch(`${API_URL}/scrape`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url })
                    });
                    
                    const data = await res.json();
                    
                    if (!res.ok) {
                        throw new Error(data.error || 'Failed to scrape recipe');
                    }
                    
                    setOriginalRecipe(data);
                    setRecipe(data);
                    setCurrentScale(1);
                    setCustomScale('1');
                    setCurrentUnit('original');
                    setTempUnit('original');
                    setCookMode(false);
                    setCurrentStep(0);
                    setCheckedIngredients({});
                    stopTimer();
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };
            
            const handleImageUpload = async (e) => {
                const file = e.target.files?.[0];
                if (!file) return;
                
                setLoading(true);
                setError(null);
                setUrl('');
                setShowShoppingList(false);
                setShoppingList(null);
                
                try {
                    const formData = new FormData();
                    formData.append('image', file);
                    
                    const res = await fetch(`${API_URL}/extract-image`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await res.json();
                    
                    if (!res.ok) {
                        throw new Error(data.error || 'Failed to extract recipe from image');
                    }
                    
                    setOriginalRecipe(data);
                    setRecipe(data);
                    setCurrentScale(1);
                    setCustomScale('1');
                    setCurrentUnit('original');
                    setTempUnit('original');
                    setCookMode(false);
                    setCurrentStep(0);
                    setCheckedIngredients({});
                    stopTimer();
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                    // Reset file input
                    if (fileInputRef.current) {
                        fileInputRef.current.value = '';
                    }
                }
            };
            
            const handleShoppingListUpload = async (e) => {
                const files = e.target.files;
                if (!files || files.length === 0) return;
                
                setLoading(true);
                setError(null);
                setRecipe(null);
                setOriginalRecipe(null);
                setShowShoppingList(true);
                
                try {
                    const formData = new FormData();
                    for (let i = 0; i < files.length; i++) {
                        formData.append('images', files[i]);
                    }
                    
                    const res = await fetch(`${API_URL}/shopping-list`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await res.json();
                    
                    if (!res.ok) {
                        throw new Error(data.error || 'Failed to create shopping list');
                    }
                    
                    setShoppingList(data.ingredients);
                } catch (err) {
                    setError(err.message);
                    setShowShoppingList(false);
                } finally {
                    setLoading(false);
                    if (shoppingInputRef.current) {
                        shoppingInputRef.current.value = '';
                    }
                }
            };
            
            const scaleFromOriginal = (factor) => {
                if (!originalRecipe) return;
                
                // Scale ingredients from original
                const scaledIngredients = originalRecipe.ingredients.map(ing => ({
                    ...ing,
                    quantity: ing.quantity ? ing.quantity * factor : null
                }));
                
                const scaledServings = originalRecipe.servings 
                    ? Math.round(originalRecipe.servings * factor) 
                    : null;
                
                setRecipe({
                    ...originalRecipe,
                    ingredients: scaledIngredients,
                    servings: scaledServings
                });
                setCurrentScale(factor);
                setCustomScale(factor.toString());
            };
            
            // Unit conversion tables
            const VOLUME_TO_ML = {
                ml: 1, milliliter: 1, milliliters: 1,
                l: 1000, liter: 1000, liters: 1000,
                tsp: 4.929, teaspoon: 4.929, teaspoons: 4.929,
                tbsp: 14.787, tablespoon: 14.787, tablespoons: 14.787,
                cup: 236.588, cups: 236.588,
                'fl oz': 29.574, 'fluid ounce': 29.574, 'fluid ounces': 29.574,
                pint: 473.176, pints: 473.176,
                quart: 946.353, quarts: 946.353,
                gallon: 3785.41, gallons: 3785.41,
            };
            
            const WEIGHT_TO_G = {
                g: 1, gram: 1, grams: 1,
                kg: 1000, kilogram: 1000, kilograms: 1000,
                oz: 28.3495, ounce: 28.3495, ounces: 28.3495,
                lb: 453.592, pound: 453.592, pounds: 453.592,
            };
            
            const convertUnit = (quantity, fromUnit, toUnit) => {
                if (!quantity || !fromUnit) return { quantity, unit: fromUnit };
                const from = fromUnit.toLowerCase();
                const to = toUnit.toLowerCase();
                
                // Volume conversion
                if (VOLUME_TO_ML[from] && VOLUME_TO_ML[to]) {
                    const ml = quantity * VOLUME_TO_ML[from];
                    return { quantity: ml / VOLUME_TO_ML[to], unit: toUnit };
                }
                // Weight conversion
                if (WEIGHT_TO_G[from] && WEIGHT_TO_G[to]) {
                    const g = quantity * WEIGHT_TO_G[from];
                    return { quantity: g / WEIGHT_TO_G[to], unit: toUnit };
                }
                return { quantity, unit: fromUnit };
            };
            
            const convertRecipeUnits = (system) => {
                if (!originalRecipe) return;
                
                const convertedIngredients = originalRecipe.ingredients.map(ing => {
                    if (!ing.quantity || !ing.unit) return { ...ing, quantity: ing.quantity ? ing.quantity * currentScale : null };
                    
                    const u = ing.unit.toLowerCase();
                    let converted = { quantity: ing.quantity, unit: ing.unit };
                    
                    if (system === 'metric') {
                        if (VOLUME_TO_ML[u] && !['ml', 'l', 'liter', 'liters'].includes(u)) {
                            converted = convertUnit(ing.quantity, ing.unit, 'ml');
                            if (converted.quantity >= 1000) {
                                converted = { quantity: converted.quantity / 1000, unit: 'L' };
                            }
                        } else if (WEIGHT_TO_G[u] && !['g', 'kg', 'gram', 'grams', 'kilogram', 'kilograms'].includes(u)) {
                            converted = convertUnit(ing.quantity, ing.unit, 'g');
                            if (converted.quantity >= 1000) {
                                converted = { quantity: converted.quantity / 1000, unit: 'kg' };
                            }
                        }
                    } else {
                        // Imperial
                        if (['ml', 'l', 'liter', 'liters'].includes(u)) {
                            converted = convertUnit(ing.quantity, ing.unit, 'cups');
                        } else if (['g', 'kg', 'gram', 'grams', 'kilogram', 'kilograms'].includes(u)) {
                            converted = convertUnit(ing.quantity, ing.unit, 'oz');
                        }
                    }
                    
                    // Apply current scale
                    return {
                        ...ing,
                        quantity: converted.quantity ? converted.quantity * currentScale : null,
                        unit: converted.unit
                    };
                });
                
                setRecipe({
                    ...recipe,
                    ingredients: convertedIngredients
                });
                setCurrentUnit(system);
            };
            
            const [tempUnit, setTempUnit] = React.useState('original'); // 'original', 'celsius', 'fahrenheit'
            const [currentUnit, setCurrentUnit] = React.useState('original');
            const [copied, setCopied] = React.useState(false);
            const [shoppingList, setShoppingList] = React.useState(null);
            const [showShoppingList, setShowShoppingList] = React.useState(false);
            const [cookMode, setCookMode] = React.useState(false);
            const [currentStep, setCurrentStep] = React.useState(0);
            const [checkedIngredients, setCheckedIngredients] = React.useState({});
            const [wakeLock, setWakeLock] = React.useState(null);
            const [activeTimer, setActiveTimer] = React.useState(null);
            const timerRef = React.useRef(null);
            
            // Timer functions
            const startTimer = (seconds, label) => {
                if (timerRef.current) clearInterval(timerRef.current);
                
                setActiveTimer({ total: seconds, remaining: seconds, label });
                
                timerRef.current = setInterval(() => {
                    setActiveTimer(prev => {
                        if (!prev || prev.remaining <= 1) {
                            clearInterval(timerRef.current);
                            timerRef.current = null;
                            // Play alert sound
                            try {
                                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                                const osc = ctx.createOscillator();
                                osc.type = 'sine';
                                osc.frequency.value = 800;
                                osc.connect(ctx.destination);
                                osc.start();
                                setTimeout(() => osc.stop(), 200);
                                setTimeout(() => {
                                    const osc2 = ctx.createOscillator();
                                    osc2.type = 'sine';
                                    osc2.frequency.value = 800;
                                    osc2.connect(ctx.destination);
                                    osc2.start();
                                    setTimeout(() => osc2.stop(), 200);
                                }, 300);
                            } catch(e) {}
                            alert('‚è∞ Timer done: ' + (prev?.label || 'Complete'));
                            return null;
                        }
                        return { ...prev, remaining: prev.remaining - 1 };
                    });
                }, 1000);
            };
            
            const stopTimer = () => {
                if (timerRef.current) {
                    clearInterval(timerRef.current);
                    timerRef.current = null;
                }
                setActiveTimer(null);
            };
            
            // Wake lock to prevent screen from sleeping in cook mode
            React.useEffect(() => {
                const requestWakeLock = async () => {
                    if (cookMode && 'wakeLock' in navigator) {
                        try {
                            const lock = await navigator.wakeLock.request('screen');
                            setWakeLock(lock);
                            console.log('Screen wake lock activated');
                        } catch (err) {
                            console.log('Wake lock failed:', err);
                        }
                    }
                };
                
                const releaseWakeLock = async () => {
                    if (wakeLock) {
                        await wakeLock.release();
                        setWakeLock(null);
                        console.log('Screen wake lock released');
                    }
                };
                
                if (cookMode) {
                    requestWakeLock();
                } else {
                    releaseWakeLock();
                }
                
                return () => releaseWakeLock();
            }, [cookMode]);
            
            // Keyboard shortcuts for cook mode
            React.useEffect(() => {
                const handleKeyDown = (e) => {
                    if (!cookMode || !recipe) return;
                    
                    // Right arrow, Space, or Enter = next step
                    if (e.key === 'ArrowRight' || e.key === ' ' || e.key === 'Enter') {
                        e.preventDefault();
                        if (currentStep < recipe.instructions.length - 1) {
                            setCurrentStep(currentStep + 1);
                        }
                    }
                    // Left arrow = previous step
                    if (e.key === 'ArrowLeft') {
                        e.preventDefault();
                        if (currentStep > 0) {
                            setCurrentStep(currentStep - 1);
                        }
                    }
                    // Escape = exit cook mode
                    if (e.key === 'Escape') {
                        setCookMode(false);
                        setCurrentStep(0);
                    }
                };
                
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [cookMode, currentStep, recipe]);
            
            const shoppingInputRef = React.useRef(null);
            
            const handleKeyDown = (e) => {
                if (e.key === 'Enter') scrapeRecipe();
            };
            
            const handleCustomScale = () => {
                const factor = parseFloat(customScale);
                if (!isNaN(factor) && factor > 0) {
                    scaleFromOriginal(factor);
                }
            };
            
            const resetRecipe = () => {
                if (originalRecipe) {
                    setRecipe(originalRecipe);
                    setCurrentScale(1);
                    setCustomScale('1');
                    setCurrentUnit('original');
                    setTempUnit('original');
                    setCookMode(false);
                    setCurrentStep(0);
                    setCheckedIngredients({});
                    stopTimer();
                }
            };
            
            return (
                <div className="container">
                    <h1>what are you cooking up?</h1>
                    <p className="subtitle">paste a URL, upload a photo, or combine multiple recipes into a shopping list</p>
                    
                    <div className="input-section">
                        <input
                            type="text"
                            value={url}
                            onChange={(e) => setUrl(e.target.value)}
                            onKeyDown={handleKeyDown}
                            placeholder="paste a recipe URL..."
                        />
                        <button 
                            className="btn-primary" 
                            onClick={scrapeRecipe}
                            disabled={loading || !url.trim()}
                        >
                            {loading ? 'Loading...' : 'Extract'}
                        </button>
                        <input
                            type="file"
                            ref={fileInputRef}
                            onChange={handleImageUpload}
                            accept="image/*"
                            style={{display: 'none'}}
                        />
                        <button 
                            className="btn-secondary"
                            onClick={() => fileInputRef.current?.click()}
                            disabled={loading}
                            style={{whiteSpace: 'nowrap'}}
                        >
                            üì∑ Upload
                        </button>
                        <input
                            type="file"
                            ref={shoppingInputRef}
                            onChange={handleShoppingListUpload}
                            accept="image/*"
                            multiple
                            style={{display: 'none'}}
                        />
                        <button 
                            className="btn-secondary"
                            onClick={() => shoppingInputRef.current?.click()}
                            disabled={loading}
                            style={{whiteSpace: 'nowrap'}}
                        >
                            üõí Shopping List
                        </button>
                    </div>
                    
                    {error && <div className="error">{error}</div>}
                    
                    {loading && (
                        <div className="loading">
                            <div className="loading-spinner"></div>
                            <p style={{marginTop: '1rem'}}>{showShoppingList ? 'Creating shopping list...' : 'Extracting recipe...'}</p>
                        </div>
                    )}
                    
                    {showShoppingList && shoppingList && !loading && (
                        <div className="recipe-card">
                            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px'}}>
                                <h2 className="recipe-title">üõí Shopping List</h2>
                                <button 
                                    className="btn-secondary" 
                                    onClick={() => {
                                        const text = shoppingList
                                            .map(ing => {
                                                const qty = ing.quantity ? formatQuantity(ing.quantity) : '';
                                                const unit = ing.unit || '';
                                                return `${qty} ${unit} ${ing.item}`.trim();
                                            })
                                            .join('\n');
                                        navigator.clipboard.writeText(text);
                                        setCopied(true);
                                        setTimeout(() => setCopied(false), 2000);
                                    }}
                                    style={{padding: '6px 12px', fontSize: '14px'}}
                                >
                                    {copied ? '‚úì Copied!' : 'üìã Copy'}
                                </button>
                            </div>
                            <p style={{color: '#666', marginBottom: '20px', fontSize: '15px'}}>
                                {shoppingList.length} ingredients from your recipes, combined and sorted
                            </p>
                            {shoppingList.map((ing, i) => (
                                <div key={i} className="ingredient">
                                    <span className="ingredient-qty">
                                        {formatQuantity(ing.quantity)} {ing.unit || ''}
                                    </span>
                                    <span className="ingredient-item">{ing.item}</span>
                                </div>
                            ))}
                        </div>
                    )}
                    
                    {recipe && !loading && !showShoppingList && (
                        <>
                            <div className="controls">
                                <button className={`btn-secondary ${currentScale === 0.5 ? 'active' : ''}`} onClick={() => scaleFromOriginal(0.5)}>¬Ω√ó</button>
                                <button className={`btn-secondary ${currentScale === 1 ? 'active' : ''}`} onClick={resetRecipe}>1√ó (reset)</button>
                                <button className={`btn-secondary ${currentScale === 2 ? 'active' : ''}`} onClick={() => scaleFromOriginal(2)}>2√ó</button>
                                <button className={`btn-secondary ${currentScale === 3 ? 'active' : ''}`} onClick={() => scaleFromOriginal(3)}>3√ó</button>
                                <div className="custom-scale">
                                    <input 
                                        type="text" 
                                        value={customScale}
                                        onChange={(e) => setCustomScale(e.target.value)}
                                        onKeyDown={(e) => e.key === 'Enter' && handleCustomScale()}
                                    />
                                    <span>√ó</span>
                                    <button className="btn-secondary" onClick={handleCustomScale}>Scale</button>
                                </div>
                                <span style={{color: '#999', margin: '0 4px'}}>|</span>
                                <button className={`btn-secondary ${currentUnit === 'original' ? 'active' : ''}`} onClick={() => { scaleFromOriginal(currentScale); setCurrentUnit('original'); }}>Original</button>
                                <button className={`btn-secondary ${currentUnit === 'metric' ? 'active' : ''}`} onClick={() => convertRecipeUnits('metric')}>Metric</button>
                                <button className={`btn-secondary ${currentUnit === 'imperial' ? 'active' : ''}`} onClick={() => convertRecipeUnits('imperial')}>Imperial</button>
                                <span style={{color: '#999', margin: '0 4px'}}>|</span>
                                <button className={`btn-secondary ${tempUnit === 'celsius' ? 'active' : ''}`} onClick={() => setTempUnit(tempUnit === 'celsius' ? 'original' : 'celsius')}>¬∞C</button>
                                <button className={`btn-secondary ${tempUnit === 'fahrenheit' ? 'active' : ''}`} onClick={() => setTempUnit(tempUnit === 'fahrenheit' ? 'original' : 'fahrenheit')}>¬∞F</button>
                            </div>
                            
                            <div className="recipe-card">
                                <div className="recipe-header">
                                    <h2 className="recipe-title">{recipe.name}</h2>
                                    <div className="recipe-meta">
                                        {recipe.servings && <span>üçΩ {recipe.servings} servings</span>}
                                        {recipe.prep_time && <span>‚è± Prep: {recipe.prep_time}</span>}
                                        {recipe.cook_time && <span>üî• Cook: {recipe.cook_time}</span>}
                                        {recipe.total_time && <span>‚è∞ Total: {recipe.total_time}</span>}
                                        {!recipe.prep_time && !recipe.cook_time && !recipe.total_time && estimateRecipeTime(recipe.instructions) && (
                                            <span title="Estimated from instructions">‚è∞ Est: {estimateRecipeTime(recipe.instructions)}</span>
                                        )}
                                    </div>
                                </div>
                                
                                <div className="ingredients">
                                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px'}}>
                                        <h3 className="section-title" style={{margin: 0}}>Ingredients</h3>
                                        <div style={{display: 'flex', gap: '8px'}}>
                                            {Object.keys(checkedIngredients).length > 0 && (
                                                <button 
                                                    className="btn-secondary" 
                                                    onClick={() => setCheckedIngredients({})}
                                                    style={{padding: '6px 12px', fontSize: '14px'}}
                                                >
                                                    ‚Ü© Reset
                                                </button>
                                            )}
                                            <button 
                                                className="btn-secondary" 
                                                onClick={() => {
                                                    const text = recipe.ingredients
                                                        .filter((_, i) => !checkedIngredients[i])
                                                        .map(ing => {
                                                            const qty = ing.quantity ? formatQuantity(ing.quantity) : '';
                                                            const unit = ing.unit || '';
                                                            return `${qty} ${unit} ${ing.item}`.trim();
                                                        })
                                                        .join('\n');
                                                    navigator.clipboard.writeText(text);
                                                    setCopied(true);
                                                    setTimeout(() => setCopied(false), 2000);
                                                }}
                                                style={{padding: '6px 12px', fontSize: '14px'}}
                                            >
                                                {copied ? '‚úì Copied!' : 'üìã Copy'}
                                            </button>
                                        </div>
                                    </div>
                                    <p style={{fontSize: '13px', color: '#999', marginBottom: '12px'}}>
                                        tap items to check off what you have
                                    </p>
                                    {/* Unchecked ingredients first */}
                                    {recipe.ingredients.map((ing, i) => (
                                        !checkedIngredients[i] && (
                                            <div 
                                                key={i} 
                                                className="ingredient"
                                                onClick={() => setCheckedIngredients(prev => ({...prev, [i]: true}))}
                                                style={{
                                                    cursor: 'pointer',
                                                    transition: 'opacity 0.2s'
                                                }}
                                            >
                                                <span className="ingredient-qty">
                                                    {formatQuantity(ing.quantity)} {ing.unit || ''}
                                                </span>
                                                <span className="ingredient-item">{ing.item}</span>
                                                <span style={{marginLeft: 'auto', color: '#ddd'}}>‚óã</span>
                                            </div>
                                        )
                                    ))}
                                    {/* Checked ingredients at bottom */}
                                    {Object.keys(checkedIngredients).length > 0 && recipe.ingredients.some((_, i) => checkedIngredients[i]) && (
                                        <div style={{marginTop: '16px', paddingTop: '16px', borderTop: '1px dashed #ddd'}}>
                                            <div style={{fontSize: '13px', color: '#888', marginBottom: '8px'}}>Have these:</div>
                                            {recipe.ingredients.map((ing, i) => (
                                                checkedIngredients[i] && (
                                                    <div 
                                                        key={i} 
                                                        className="ingredient"
                                                        onClick={() => setCheckedIngredients(prev => {
                                                            const next = {...prev};
                                                            delete next[i];
                                                            return next;
                                                        })}
                                                        style={{
                                                            cursor: 'pointer',
                                                            opacity: 0.4,
                                                            textDecoration: 'line-through',
                                                            transition: 'opacity 0.2s'
                                                        }}
                                                    >
                                                        <span className="ingredient-qty" style={{textDecoration: 'line-through'}}>
                                                            {formatQuantity(ing.quantity)} {ing.unit || ''}
                                                        </span>
                                                        <span className="ingredient-item">{ing.item}</span>
                                                        <span style={{marginLeft: 'auto', color: '#4CAF50'}}>‚úì</span>
                                                    </div>
                                                )
                                            ))}
                                        </div>
                                    )}
                                </div>
                                
                                <div className="instructions">
                                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px'}}>
                                        <h3 className="section-title" style={{margin: 0}}>Instructions</h3>
                                        <button 
                                            className="btn-secondary"
                                            onClick={() => { setCookMode(!cookMode); setCurrentStep(0); }}
                                            style={{padding: '6px 12px', fontSize: '14px'}}
                                        >
                                            {cookMode ? 'üìñ View All' : 'üë®‚Äçüç≥ Cook Mode'}
                                        </button>
                                    </div>
                                    {currentScale !== 1 && (
                                        <p style={{fontSize: '14px', color: '#888', fontStyle: 'italic', marginBottom: '16px'}}>
                                            Note: quantities in instructions are not adjusted for scaling.
                                        </p>
                                    )}
                                    
                                    {cookMode ? (
                                        <div style={{padding: '20px', background: '#f9f6ee', borderRadius: '8px'}}>
                                            {/* Active timer display */}
                                            {activeTimer && (
                                                <div style={{
                                                    background: '#CC5500', 
                                                    color: 'white', 
                                                    padding: '12px 20px', 
                                                    borderRadius: '8px', 
                                                    marginBottom: '16px',
                                                    display: 'flex',
                                                    justifyContent: 'space-between',
                                                    alignItems: 'center'
                                                }}>
                                                    <div>
                                                        <div style={{fontSize: '28px', fontWeight: 'bold', fontFamily: 'monospace'}}>
                                                            {formatTime(activeTimer.remaining)}
                                                        </div>
                                                        <div style={{fontSize: '12px', opacity: 0.8}}>{activeTimer.label}</div>
                                                    </div>
                                                    <button 
                                                        onClick={stopTimer}
                                                        style={{
                                                            background: 'rgba(255,255,255,0.2)', 
                                                            border: 'none', 
                                                            color: 'white', 
                                                            padding: '8px 16px', 
                                                            borderRadius: '4px',
                                                            cursor: 'pointer'
                                                        }}
                                                    >
                                                        ‚úï Cancel
                                                    </button>
                                                </div>
                                            )}
                                            
                                            <div style={{fontSize: '14px', color: '#888', marginBottom: '12px'}}>
                                                Step {currentStep + 1} of {recipe.instructions.length}
                                            </div>
                                            <p style={{fontSize: '20px', lineHeight: '1.7', color: '#333', marginBottom: '16px'}}>
                                                {convertTemperatureInText(recipe.instructions[currentStep], tempUnit)}
                                            </p>
                                            
                                            {/* Timer button if time detected */}
                                            {extractTime(recipe.instructions[currentStep]) && !activeTimer && (
                                                <button
                                                    onClick={() => {
                                                        const time = extractTime(recipe.instructions[currentStep]);
                                                        if (time) startTimer(time.seconds, time.label);
                                                    }}
                                                    style={{
                                                        background: '#4CAF50',
                                                        color: 'white',
                                                        border: 'none',
                                                        padding: '10px 20px',
                                                        borderRadius: '6px',
                                                        cursor: 'pointer',
                                                        marginBottom: '16px',
                                                        fontSize: '15px'
                                                    }}
                                                >
                                                    ‚è± Start timer: {extractTime(recipe.instructions[currentStep]).label}
                                                </button>
                                            )}
                                            
                                            <div style={{display: 'flex', gap: '12px', marginBottom: '16px'}}>
                                                <button 
                                                    className="btn-secondary"
                                                    onClick={() => setCurrentStep(Math.max(0, currentStep - 1))}
                                                    disabled={currentStep === 0}
                                                    style={{padding: '10px 20px'}}
                                                >
                                                    ‚Üê Back
                                                </button>
                                                {currentStep < recipe.instructions.length - 1 ? (
                                                    <button 
                                                        className="btn-primary"
                                                        onClick={() => setCurrentStep(currentStep + 1)}
                                                        style={{padding: '10px 20px'}}
                                                    >
                                                        Done, Next ‚Üí
                                                    </button>
                                                ) : (
                                                    <button 
                                                        className="btn-primary"
                                                        onClick={() => { setCookMode(false); setCurrentStep(0); }}
                                                        style={{padding: '10px 20px'}}
                                                    >
                                                        üéâ Finished!
                                                    </button>
                                                )}
                                            </div>
                                            <div style={{fontSize: '12px', color: '#aaa'}}>
                                                Keyboard: ‚Üê/‚Üí or Space to navigate ‚Ä¢ Esc to exit ‚Ä¢ Screen stays on
                                            </div>
                                        </div>
                                    ) : (
                                        <ol>
                                        {recipe.instructions.map((step, i) => (
                                            <li key={i}>{convertTemperatureInText(step, tempUnit)}</li>
                                        ))}
                                    </ol>
                                    )}
                                </div>
                                
                                {recipe.source_url && (
                                    <div className="source-link">
                                        <a href={recipe.source_url} target="_blank" rel="noopener noreferrer">
                                            View original recipe ‚Üó
                                        </a>
                                    </div>
                                )}
                            </div>
                        </>
                    )}
                </div>
            );
        }
        
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>